name: Delete abandoned branches

on:
    # Run weekly on Sunday midnight
    schedule:
        - cron: '0 0 * * 0'

    # Allow workflow to be manually run from the GitHub UI
    workflow_dispatch:

jobs:
    cleanup_old_branches:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: Configure Git user
              run: |
                git config --global user.name "AbhiChanGit"
                git config --global user.email "abhishek.23.01.2005@gmail.com"

            - name: Get unused Branches
              uses: phpdocker-io/github-actions-delete-abandoned-branches@v2
              id: unused_branches
              with:
                github_token: ${{ github.token }}
                last_commit_age_days: 0
                dry_run: yes

            - name: Prefix branches with delete
              run: |
                # List of branches to be deleted
                deleted=$(echo "${{ steps.unused_branches.outputs.deleted_branches }}" | sed "s/[][]//g; s/,/ /g; s/'//g")
                echo "Deleted branches: $deleted"
                
                # List of remote branches
                remote_branches=$(git branch -r | sed 's/ *origin\///g' | grep -v "HEAD")
                echo "Remote branches: $remote_branches"
                
                # For each remote branch, check if it is in the deleted branches list
                for branch in $remote_branches; do
                  echo "Checking branch: $branch"
                  if [[ " $deleted " == *" $branch "* ]]; then
                    echo "Branch '$branch' is marked for deletion. Renaming to delete/$branch..."
                    git checkout "$branch"
                    git branch -m "delete/$branch"
                    git push origin --delete "$branch"
                    git push origin "delete/$branch"
                  else
                    echo "Branch '$branch' is not marked for deletion."
                  fi
                done

            - name: Create branch for PR
              run: |
                git checkout -b delete-branches-${{ github.sha }}
                git commit --allow-empty -m "Prepare PR for abandoned branch deletion"
                git push origin delete-branches-${{ github.sha }}

            - name: Create pull request for branch deletion
              env:
                GH_TOKEN: ${{ github.token }}
              run: |
                gh pr create \
                  --title "Delete abandoned branches" \
                  --body "This pull request proposes to delete the following abandoned branches:

                  ${{ steps.unused_branches.outputs.deleted_branches }}
                  | Branch Name | Last Commit Date | Last Commit Message | Last Updated |
                  |-------------|------------------|---------------------|--------------|
                  {% for branch in steps.unused_branches.outputs.deleted_branches %}
                  | {{ branch.name }} | {{ branch.last_commit_date }} | {{ branch.last_commit_message }} | {{ branch.last_updated }} |
                  {% endfor %}" \
                  --base main \
                  --head delete-branches-${{ github.sha }}

                  
            - name: Get output
              run: "echo 'Deleted branches: ${{ steps.unused_branches.outputs.deleted_branches }}'"
